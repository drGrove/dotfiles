var AddonChange={};var AddonComment={};onUpdate=function(){};function start(){const c=chrome.settings.get("debug");function f(h){var g={};h.forEach(function(i){g[i.uid]=$.extend(true,i.toJSON(),{data:i.data,images:i.images,commented:new Date(i.commented)})});return g}function e(j,i){c&&console.log("notify",j);var g=Object.keys(j).map(function(k){return j[k]});if(g.length>0){webkitNotifications.createHTMLNotification([chrome.extension.getURL("chrome/notification.html"),chrome.notification.encode({property:i,changes:g})].join("#")).show()}AddonChange={};try{onUpdate()}catch(h){}}function b(g){Stats.updateCatalog(chrome.settings.get("catalog.max"),function(){Stats.updateSelected(g)})}function a(){Stats.getCatalog(function(g,h){if(!h||new Date()-h.updated>chrome.settings.get("catalog.interval")){b()}})}function d(){c&&console.log("checkUpdate",(new Date()).toLocaleString().split("GMT")[0]);Stats.list(function(g){var h=f(g);c&&console.log("previousAddonObject",h);Stats.updateSelected(function(){var i=[];Stats.list(function(k){var m=[];var l=false;c&&console.log("currentAddons",k);k.forEach(function(n){c&&console.log(n.name);var o=[];if(n.uid in h){var q=h[n.uid];["users"].forEach(function(s){var r=q[s]!=n[s];c&&console[n[s],q[s]!=n[s]?"warn":"log"]("\t",r,"  =>  ",r?"updated !":"no change");if(r){if(s=="users"){l=true}AddonChange[n.uid]=AddonChange[n.uid]||{addon:n,change:{}};AddonChange[n.uid].change[s]={current:n[s],previous:s in AddonChange[n.uid].change?AddonChange[n.uid].change[s].previous:q[s]}}});var p=q.comments!=n.comments&&q.commented&&n.commented&&(new Date(q.commented)).getTime()!=(new Date(n.commented)).getTime();c&&console[p?"warn":"log"]("\t","comments",q.comments,n.comments,p?"updated !":"no change",{previous:(new Date(q.commented)).toString(),current:(new Date(n.commented)).toString()});if(p){m.push(n)}}});if(Object.keys(AddonChange).length>0){chrome.idle.deferExecution(function(){e(AddonChange,"users");Addonchange={}})}var j=m.length;m.forEach(function(n){ChromeWebstore.getComments(n.uid,function(o){if(!(n.uid in AddonComment)){AddonComment[n.uid]={addon:n,comments:[]}}AddonComment[n.uid].comments=o.items.filter(function(p){return true||p.date>previousAddon.commented}).slice(0,1);if(Object.keys(AddonComment).length>0&&--j==0){chrome.idle.deferExecution(function(){e(AddonComment,"comments");AddonComment={}})}})});if(l){c&&console.log("catalog needs update");b()}})})})}if(!chrome.settings.has("installed")){chrome.tabs.create({url:"chrome/app.html"},function(){chrome.settings.set("installed",true)})}setInterval(d,chrome.settings.get("interval"));d();setInterval(a,chrome.settings.get("catalog.interval"));a()}Database.init(start);