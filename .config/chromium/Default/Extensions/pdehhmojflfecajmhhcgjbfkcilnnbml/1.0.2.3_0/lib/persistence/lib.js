if(typeof exports!=="undefined"){exports.createPersistence=function(){return initPersistence({})};var singleton;exports.__defineGetter__("persistence",function(){if(!singleton){singleton=exports.createPersistence()}return singleton})}else{window=window||{};window.persistence=initPersistence(window.persistence||{})}function initPersistence(b){if(b.isImmutable){return b}b.isImmutable=function(c){return(c=="id")};b.defineProp=function(d,f,g,c){d.__defineSetter__(f,function(h){g(h)});d.__defineGetter__(f,function(){return c()})};b.set=function(c,f,d){if(b.isImmutable(f)){throw new Error("immutable field: "+f)}c[f]=d};b.get=function(d,c){return(arguments.length==1)?d:d[c]};(function(){var d={};var v={};b.getEntityMeta=function(){return d};b.trackedObjects={};b.objectsToRemove={};b.objectsRemoved=[];b.globalPropertyListeners={};b.queryCollectionCache={};b.getObjectsToRemove=function(){return this.objectsToRemove};b.getTrackedObjects=function(){return this.trackedObjects};b.entityDecoratorHooks=[];b.flushHooks=[];b.schemaSyncHooks=[];b.debug=true;b.subscribeToGlobalPropertyListener=function(A,z,C){var y=z+"__"+C;if(y in this.globalPropertyListeners){var B=this.globalPropertyListeners[y];for(var x=0;x<B.length;x++){if(B[x]===A){return}}this.globalPropertyListeners[y].push(A)}else{this.globalPropertyListeners[y]=[A]}};b.unsubscribeFromGlobalPropertyListener=function(A,z,C){var y=z+"__"+C;var B=this.globalPropertyListeners[y];for(var x=0;x<B.length;x++){if(B[x]===A){B.splice(x,1);return}}};b.propertyChanged=function(C,H,y,A){if(!this.trackedObjects[C.id]){return}var G=C._type;var I=G+"__"+H;if(I in this.globalPropertyListeners){var F=this.globalPropertyListeners[I];for(var D=0;D<F.length;D++){var x=F[D];var E=C._data;E[H]=y;var B=x._filter.match(E);E[H]=A;var z=x._filter.match(E);if(B!=z){x.triggerEvent("change",x,C)}}}};b.objectRemoved=function(B){var z=B._type;if(this.queryCollectionCache[z]){var A=this.queryCollectionCache[z];for(var y in A){if(A.hasOwnProperty(y)){var x=A[y];if(x._filter.match(B)){x.triggerEvent("change",x,B)}}}}};function f(x){return d[x]}b.getMeta=f;function r(x){this.trackedObjects={};this.objectsToRemove={};this.objectsRemoved=[];this.globalPropertyListeners={};this.queryCollectionCache={};this.conn=x}r.prototype=b;b.Session=r;b.define=function(y,x){if(d[y]){return k(y)}var z={name:y,fields:x,isMixin:false,indexes:[],hasMany:{},hasOne:{}};d[y]=z;return k(y)};b.isDefined=function(x){return !!d[x]};b.defineMixin=function(y,x){var z=this.define(y,x);z.meta.isMixin=true;return z};b.isTransaction=function(x){return !x||(x&&x.executeSql)};b.isSession=function(x){return !x||(x&&x.schemaSync)};b.add=function(y){if(!y){return}if(!this.trackedObjects[y.id]){this.trackedObjects[y.id]=y;if(y._new){for(var x in y._data){if(y._data.hasOwnProperty(x)){this.propertyChanged(y,x,undefined,y._data[x])}}}}return this};b.remove=function(x){if(!this.objectsToRemove[x.id]){this.objectsToRemove[x.id]=x}this.objectsRemoved.push({id:x.id,entity:x._type});this.objectRemoved(x);return this};b.clean=function(){this.trackedObjects={};this.objectsToRemove={};this.objectsRemoved=[];this.globalPropertyListeners={};this.queryCollectionCache={}};b.asyncForEach=function(A,y,z){A=A.slice(0);function x(){var B=A.pop();y(B,function(C,D){if(A.length>0){x()}else{z(C,D)}})}if(A.length>0){x()}else{z()}};b.asyncParForEach=function(C,A,B){var z=0;var x=C.length;if(x===0){B()}for(var y=0;y<x;y++){A(C[y],function(D,E){z++;if(z===x){B(D,E)}})}};function k(z){if(v[z]){return v[z]}var B=d[z];function C(K,J,D){var E=a.getArgs(arguments,[{name:"session",optional:true,check:b.isSession,defaultValue:b},{name:"obj",optional:true,check:function(L){return L},defaultValue:{}}]);if(B.isMixin){throw new Error("Cannot instantiate mixin")}K=E.session;J=E.obj;var G=this;this.id=J.id||b.createUUID();this._new=true;this._type=z;this._dirtyProperties={};this._data={};this._data_obj={};this._session=K||b;this.subscribers={};for(var I in B.fields){(function(){if(B.fields.hasOwnProperty(I)){var L=I;b.defineProp(G,L,function(N){var M=G._data[L];if(M!==N||(M&&N&&M.getTime&&N.getTime)){G._data[L]=N;G._dirtyProperties[L]=M;G.triggerEvent("set",G,L,N);G.triggerEvent("change",G,L,N);K.propertyChanged(G,L,M,N)}},function(){return G._data[L]});G._data[I]=s(B.fields[I])}}())}for(var F in B.hasOne){if(B.hasOne.hasOwnProperty(F)){(function(){var L=F;var M=B.hasOne[F].type.meta.isMixin?L+"_class":null;b.defineProp(G,L,function(R){var P=G._data[L];var Q=G._data_obj[L]||K.trackedObjects[G._data[L]];if(R==null){G._data[L]=null;G._data_obj[L]=undefined;if(M){G[M]=""}}else{if(R.id){G._data[L]=R.id;G._data_obj[L]=R;if(M){G[M]=R._type}K.add(R);K.add(G)}else{G._data[L]=R}}G._dirtyProperties[L]=P;G.triggerEvent("set",G,L,R);G.triggerEvent("change",G,L,R);if(B.hasOne[L].inverseProperty){var O=G[L];if(O){var N=O[B.hasOne[L].inverseProperty];if(N.list&&N._filter){N.triggerEvent("change",G,L,R)}}if(Q){var N=Q[B.hasOne[L].inverseProperty];if(N.list&&N._filter){N.triggerEvent("change",G,L,R)}}}},function(){if(!G._data[L]){return null}else{if(G._data_obj[L]!==undefined){return G._data_obj[L]}else{if(G._data[L]&&K.trackedObjects[G._data[L]]){G._data_obj[L]=K.trackedObjects[G._data[L]];return G._data_obj[L]}else{throw new Error("Property '"+L+"' with id: "+G._data[L]+" not fetched, either prefetch it or fetch it manually.")}}}})}())}}for(var F in B.hasMany){if(B.hasMany.hasOwnProperty(F)){(function(){var L=F;if(B.hasMany[L].manyToMany){b.defineProp(G,L,function(O){if(O&&O._items){var M=O._items;for(var N=0;N<M.length;N++){b.get(G,L).add(M[N])}}else{throw new Error("Not yet supported.")}},function(){if(G._data[L]){return G._data[L]}else{var N=B.hasMany[L];var P=N.type.meta;var M=P.hasMany[N.inverseProperty];var R=N.mixin?N.mixin.meta.name:B.name;var O=M.mixin?M.mixin.meta.name:P.name;var Q=new b.ManyToManyDbQueryCollection(K,P.name);Q.initManyToMany(G,L);Q._manyToManyFetch={table:N.tableName,prop:R+"_"+L,inverseProp:O+"_"+N.inverseProperty,id:G.id};G._data[L]=Q;return K.uniqueQueryCollection(Q)}})}else{b.defineProp(G,L,function(O){if(O&&O._items){var M=O._items;for(var N=0;N<M.length;N++){b.get(G,L).add(M[N])}}else{throw new Error("Not yet supported.")}},function(){if(G._data[L]){return G._data[L]}else{var M=K.uniqueQueryCollection(new b.DbQueryCollection(K,B.hasMany[L].type.meta.name).filter(B.hasMany[L].inverseProperty,"=",G));G._data[L]=M;return M}})}}())}}if(this.initialize){this.initialize()}for(var H in J){if(J.hasOwnProperty(H)){if(H!=="id"){b.set(G,H,J[H])}}}}C.prototype=new m();C.meta=B;C.prototype.equals=function(D){return this.id==D.id};C.prototype.toJSON=function(){var D={id:this.id};for(var E in this._data){if(this._data.hasOwnProperty(E)){if(typeof this._data[E]=="object"&&this._data[E]!=null){if(this._data[E].toJSON!=undefined){D[E]=this._data[E].toJSON()}}else{D[E]=this._data[E]}}}return D};C.prototype.selectJSON=function(D,G,I){var H=this;var F=a.getArgs(arguments,[{name:"tx",optional:true,check:b.isTransaction,defaultValue:null},{name:"props",optional:false},{name:"callback",optional:false}]);D=F.tx;G=F.props;I=F.callback;if(!D){this._session.transaction(function(J){H.selectJSON(J,G,I)});return}var E={};G.forEach(function(P){var O=E;var N=P.split(".");for(var L=0;L<N.length;L++){var K=N[L];if(L===N.length-1){if(K==="*"){O.id=true;for(var M in B.fields){if(B.fields.hasOwnProperty(M)){O[M]=true}}for(var M in B.hasOne){if(B.hasOne.hasOwnProperty(M)){O[M]=true}}for(var M in B.hasMany){if(B.hasMany.hasOwnProperty(M)){O[M]=true}}}else{if(K[0]==="["){K=K.substring(1,K.length-1);var J=K.split(/,\s*/);J.forEach(function(Q){O[Q]=true})}else{O[K]=true}}}else{O[K]=O[K]||{};O=O[K]}}});A(this,D,E,I)};function A(H,G,O,L){var J=H._session;var I=[];var N=f(H._type);var K=N.fields;for(var E in O){if(O.hasOwnProperty(E)){I.push(E)}}var D=[];var P=[];I.forEach(function(Q){if(O[Q]===true&&!N.hasMany[Q]){D.push(Q)}else{P.push(Q)}});var F=H._data;var M={};D.forEach(function(Q){if(Q==="id"){M.id=H.id}else{if(N.hasOne[Q]){M[Q]=F[Q]?{id:F[Q]}:null}else{M[Q]=b.entityValToJson(F[Q],K[Q])}}});I=P.slice();b.asyncForEach(I,function(Q,R){if(N.hasOne[Q]){H.fetch(G,Q,function(S){if(S){A(S,G,O[Q],function(T){M[Q]=T;R()})}else{M[Q]=null;R()}})}else{if(N.hasMany[Q]){b.get(H,Q).list(function(S){M[Q]=[];b.asyncForEach(S,function(T,U){var T=S.pop();if(O[Q]===true){M[Q].push({id:T.id});U()}else{A(T,G,O[Q],function(V){M[Q].push(V);U()})}},R)})}}},function(){L(M)})}C.prototype.fetch=function(E,D,J){var F=a.getArgs(arguments,[{name:"tx",optional:true,check:b.isTransaction,defaultValue:null},{name:"rel",optional:false,check:a.hasType("string")},{name:"callback",optional:false,check:a.isCallback()}]);E=F.tx;D=F.rel;J=F.callback;var H=this;var I=this._session;if(!E){I.transaction(function(K){H.fetch(K,D,J)});return}if(!this._data[D]){if(J){J(null)}}else{if(this._data_obj[D]){if(J){J(this._data_obj[D])}}else{var G=B.hasOne[D].type;if(G.meta.isMixin){G=k(this._data[D+"_class"])}G.load(I,E,this._data[D],function(K){H._data_obj[D]=K;if(J){J(K)}})}}};C.prototype.markDirty=function(D){this._dirtyProperties[D]=true};C.all=function(E){var D=a.getArgs(arguments,[{name:"session",optional:true,check:b.isSession,defaultValue:b}]);E=D.session;return E.uniqueQueryCollection(new l(E,z))};C.fromSelectJSON=function(G,D,I,H){var E=a.getArgs(arguments,[{name:"session",optional:true,check:b.isSession,defaultValue:b},{name:"tx",optional:true,check:b.isTransaction,defaultValue:null},{name:"jsonObj",optional:false},{name:"callback",optional:false,check:a.isCallback()}]);G=E.session;D=E.tx;I=E.jsonObj;H=E.callback;if(!D){G.transaction(function(J){C.fromSelectJSON(G,J,I,H)});return}if(typeof I==="string"){I=JSON.parse(I)}if(!I){H(null);return}function F(L){if(!L){L=new C(G);if(I.id){L.id=I.id}}G.add(L);var J=[];for(var K in I){if(I.hasOwnProperty(K)){if(K==="id"){continue}else{if(B.fields[K]){b.set(L,K,b.jsonToEntityVal(I[K],B.fields[K]))}else{if(B.hasOne[K]||B.hasMany[K]){J.push(K)}}}}}b.asyncForEach(J,function(P,Q){if(B.hasOne[P]){B.hasOne[P].type.fromSelectJSON(G,D,I[P],function(R){b.set(L,P,R);Q()})}else{if(B.hasMany[P]){var O=b.get(L,P);var M=I[P].slice(0);var N=B.hasMany[P].type;O.list(D,function(R){b.asyncForEach(M,function(S,T){N.fromSelectJSON(G,D,S,function(U){for(var V=0;V<R.length;V++){if(R[V].id===U.id){T();return}}O.add(U);T()})},function(){Q()})})}}},function(){H(L)})}if(I.id){C.load(G,D,I.id,F)}else{F(new C(G))}};C.load=function(F,D,H,G){var E=a.getArgs(arguments,[{name:"session",optional:true,check:b.isSession,defaultValue:b},{name:"tx",optional:true,check:b.isTransaction,defaultValue:null},{name:"id",optional:false,check:a.hasType("string")},{name:"callback",optional:true,check:a.isCallback(),defaultValue:function(){}}]);C.findBy(E.session,E.tx,"id",E.id,E.callback)};C.findBy=function(H,D,G,F,I){var E=a.getArgs(arguments,[{name:"session",optional:true,check:b.isSession,defaultValue:b},{name:"tx",optional:true,check:b.isTransaction,defaultValue:null},{name:"property",optional:false,check:a.hasType("string")},{name:"value",optional:false},{name:"callback",optional:true,check:a.isCallback(),defaultValue:function(){}}]);H=E.session;D=E.tx;G=E.property;F=E.value;I=E.callback;if(G==="id"&&F in H.trackedObjects){I(H.trackedObjects[F]);return}if(!D){H.transaction(function(J){C.findBy(H,J,G,F,I)});return}C.all(H).filter(G,"=",F).one(D,function(J){I(J)})};C.index=function(F,D){var E=D||{};if(typeof F=="string"){F=[F]}E.columns=F;B.indexes.push(E)};C.hasMany=function(F,H,D){var G=H.meta;if(G.hasMany[D]){var E=B.name+"_"+F+"_"+G.name;var I=G.name+"_"+D+"_"+B.name;if(E>I){E=I}B.hasMany[F]={type:H,inverseProperty:D,manyToMany:true,tableName:E};G.hasMany[D]={type:C,inverseProperty:F,manyToMany:true,tableName:E};delete B.hasOne[F];delete B.fields[F+"_class"]}else{B.hasMany[F]={type:H,inverseProperty:D};G.hasOne[D]={type:C,inverseProperty:F};if(B.isMixin){G.fields[D+"_class"]=b.typeMapper?b.typeMapper.classNameType:"TEXT"}}};C.hasOne=function(F,E,D){B.hasOne[F]={type:E,inverseProperty:D};if(E.meta.isMixin){B.fields[F+"_class"]=b.typeMapper?b.typeMapper.classNameType:"TEXT"}};C.is=function(D){var F=D.meta;if(!F.isMixin){throw new Error("not a mixin: "+D)}D.meta.mixedIns=D.meta.mixedIns||[];D.meta.mixedIns.push(B);for(var G in F.fields){if(F.fields.hasOwnProperty(G)){B.fields[G]=F.fields[G]}}for(var E in F.hasOne){if(F.hasOne.hasOwnProperty(E)){B.hasOne[E]=F.hasOne[E]}}for(var E in F.hasMany){if(F.hasMany.hasOwnProperty(E)){F.hasMany[E].mixin=D;B.hasMany[E]=F.hasMany[E]}}};var y=b.entityDecoratorHooks;for(var x=0;x<y.length;x++){y[x](C)}v[z]=C;return C}b.jsonToEntityVal=function(y,x){if(x){switch(x){case"DATE":if(typeof y==="number"){if(y>1000000000000){return new Date(y)}else{return new Date(y*1000)}}else{return null}break;default:return y}}else{return y}};b.entityValToJson=function(y,x){if(x){switch(x){case"DATE":if(y){y=new Date(y);return Math.round(y.getTime()/1000)}else{return null}break;default:return y}}else{return y}};b.dump=function(y,B,C){var z=a.getArgs(arguments,[{name:"tx",optional:true,check:b.isTransaction,defaultValue:null},{name:"entities",optional:true,check:function(D){return !D||(D&&D.length&&!D.apply)},defaultValue:null},{name:"callback",optional:false,check:a.isCallback(),defaultValue:function(){}}]);y=z.tx;B=z.entities;C=z.callback;if(!B){B=[];for(var A in v){if(v.hasOwnProperty(A)){B.push(v[A])}}}var x={};b.asyncParForEach(B,function(E,D){E.all().list(y,function(G){var F=[];b.asyncParForEach(G,function(N,Q){var J={};var L=E.meta.fields;for(var M in L){if(L.hasOwnProperty(M)){J[M]=b.entityValToJson(N._data[M],L[M])}}var O=E.meta.hasOne;for(var I in O){if(O.hasOwnProperty(I)){J[I]=N._data[I]}}var K=E.meta.hasMany;var P=[];for(var H in K){if(K.hasOwnProperty(H)){P.push(H)}}b.asyncParForEach(P,function(S,T){var R=b.get(N,S);R.list(y,function(U){J[S]=U.map(function(V){return V.id});T()})},function(){J.id=N.id;F.push(J);Q()})},function(){x[E.meta.name]=F;D()})})},function(){C(x)})};b.load=function(E,G,M){var I=a.getArgs(arguments,[{name:"tx",optional:true,check:b.isTransaction,defaultValue:null},{name:"dump",optional:false},{name:"callback",optional:true,check:a.isCallback(),defaultValue:function(){}}]);E=I.tx;G=I.dump;M=I.callback;var B=0;var N=[];var J=this;for(var K in G){if(G.hasOwnProperty(K)){var C=k(K);var F=C.meta.fields;var y=G[K];for(var D=0;D<y.length;D++){var L=y[D];var H=new C();H.id=L.id;for(var A in L){if(L.hasOwnProperty(A)){if(b.isImmutable(A)){H[A]=L[A]}else{if(C.meta.hasMany[A]){var z=C.meta.hasMany[A];if(z.manyToMany&&C.meta.name<z.type.meta.name){continue}var x=b.get(H,A);if(L[A].length>0){L[A].forEach(function(O){N.push({Entity:C,coll:x,id:O})})}}else{b.set(H,A,b.jsonToEntityVal(L[A],F[A]))}}}}this.add(H)}}}J.flush(E,function(){b.asyncForEach(N,function(O,P){O.Entity.load(J,E,O.id,function(Q){O.coll.add(Q);P()})},function(){J.flush(E,M)})})};b.dumpToJson=function(x,z,A){var y=a.getArgs(arguments,[{name:"tx",optional:true,check:b.isTransaction,defaultValue:null},{name:"entities",optional:true,check:function(B){return B&&B.length&&!B.apply},defaultValue:null},{name:"callback",optional:false,check:a.isCallback(),defaultValue:function(){}}]);x=y.tx;z=y.entities;A=y.callback;this.dump(x,z,function(B){A(JSON.stringify(B))})};b.loadFromJson=function(x,z,A){var y=a.getArgs(arguments,[{name:"tx",optional:true,check:b.isTransaction,defaultValue:null},{name:"jsonDump",optional:false},{name:"callback",optional:true,check:a.isCallback(),defaultValue:function(){}}]);x=y.tx;z=y.jsonDump;A=y.callback;this.load(x,JSON.parse(z),A)};function i(){if(b.typeMapper&&b.typeMapper.newUuid){return b.typeMapper.newUuid()}var A=[];var x="0123456789ABCDEF";for(var y=0;y<32;y++){A[y]=x.substr(Math.floor(Math.random()*16),1)}A[12]="4";A[16]=x.substr((A[16]&3)|8,1);var z=A.join("");return z}b.createUUID=i;function s(x){if(b.typeMapper&&b.typeMapper.defaultValue){return b.typeMapper.defaultValue(x)}switch(x){case"TEXT":return"";case"BOOL":return false;default:if(x.indexOf("INT")!==-1){return 0}else{if(x.indexOf("CHAR")!==-1){return""}else{return null}}}}function u(y,B){var x=y.length;for(var z=0;z<x;z++){var A=y[z];if(A.equals&&A.equals(B)){return true}else{if(A===B){return true}}}return false}function j(y,B){var x=y.length;for(var z=0;z<x;z++){var A=y[z];if(A.equals&&A.equals(B)){y.splice(z,1)}else{if(A===B){y.splice(z,1)}}}}function o(z,x,y){this.obj=z;this.eventType=x;this.fn=y}o.prototype.unsubscribe=function(){this.obj.removeEventListener(this.eventType,this.fn)};function m(){this.subscribers={}}m.prototype.addEventListener=function(x,y){if(!this.subscribers[x]){this.subscribers[x]=[]}this.subscribers[x].push(y);return new o(this,x,y)};m.prototype.removeEventListener=function(y,z){var A=this.subscribers[y];for(var x=0;x<A.length;x++){if(A[x]==z){this.subscribers[y].splice(x,1);return true}}return false};m.prototype.triggerEvent=function(y){if(!this.subscribers[y]){return}var z=this.subscribers[y].slice(0);for(var x=0;x<z.length;x++){z[x].apply(null,arguments)}};function g(){}g.prototype.match=function(x){return true};g.prototype.makeFit=function(x){};g.prototype.makeNotFit=function(x){};g.prototype.toUniqueString=function(){return"NULL"};g.prototype.subscribeGlobally=function(){};g.prototype.unsubscribeGlobally=function(){};function h(y,x){this.left=y;this.right=x}h.prototype.match=function(x){return this.left.match(x)&&this.right.match(x)};h.prototype.makeFit=function(x){this.left.makeFit(x);this.right.makeFit(x)};h.prototype.makeNotFit=function(x){this.left.makeNotFit(x);this.right.makeNotFit(x)};h.prototype.toUniqueString=function(){return this.left.toUniqueString()+" AND "+this.right.toUniqueString()};h.prototype.subscribeGlobally=function(y,x){this.left.subscribeGlobally(y,x);this.right.subscribeGlobally(y,x)};h.prototype.unsubscribeGlobally=function(y,x){this.left.unsubscribeGlobally(y,x);this.right.unsubscribeGlobally(y,x)};function n(y,x){this.left=y;this.right=x}n.prototype.match=function(x){return this.left.match(x)||this.right.match(x)};n.prototype.makeFit=function(x){this.left.makeFit(x);this.right.makeFit(x)};n.prototype.makeNotFit=function(x){this.left.makeNotFit(x);this.right.makeNotFit(x)};n.prototype.toUniqueString=function(){return this.left.toUniqueString()+" OR "+this.right.toUniqueString()};n.prototype.subscribeGlobally=function(y,x){this.left.subscribeGlobally(y,x);this.right.subscribeGlobally(y,x)};n.prototype.unsubscribeGlobally=function(y,x){this.left.unsubscribeGlobally(y,x);this.right.unsubscribeGlobally(y,x)};function q(z,x,y){this.property=z;this.operator=x.toLowerCase();this.value=y}q.prototype.match=function(z){var x=this.value;var y=b.get(z,this.property);if(x&&x.getTime){x=Math.round(x.getTime()/1000)*1000;if(y&&y.getTime){y=Math.round(y.getTime()/1000)*1000}}switch(this.operator){case"=":return y===x;break;case"!=":return y!==x;break;case"<":return y<x;break;case"<=":return y<=x;break;case">":return y>x;break;case">=":return y>=x;break;case"in":return u(x,y);break;case"not in":return !u(x,y);break}};q.prototype.makeFit=function(x){if(this.operator==="="){b.set(x,this.property,this.value)}else{throw new Error("Sorry, can't perform makeFit for other filters than =")}};q.prototype.makeNotFit=function(x){if(this.operator==="="){b.set(x,this.property,null)}else{throw new Error("Sorry, can't perform makeNotFit for other filters than =")}};q.prototype.subscribeGlobally=function(y,x){b.subscribeToGlobalPropertyListener(y,x,this.property)};q.prototype.unsubscribeGlobally=function(y,x){b.unsubscribeFromGlobalPropertyListener(y,x,this.property)};q.prototype.toUniqueString=function(){var x=this.value;if(x&&x._type){x=x.id}return this.property+this.operator+x};b.NullFilter=g;b.AndFilter=h;b.OrFilter=n;b.PropertyFilter=q;b.uniqueQueryCollection=function(z){var y=z._entityName;if(z._items){return z}if(!this.queryCollectionCache[y]){this.queryCollectionCache[y]={}}var x=z.toUniqueString();if(!this.queryCollectionCache[y][x]){this.queryCollectionCache[y][x]=z}return this.queryCollectionCache[y][x]};function c(){}c.prototype=new m();c.prototype.oldAddEventListener=c.prototype.addEventListener;c.prototype.setupSubscriptions=function(){this._filter.subscribeGlobally(this,this._entityName)};c.prototype.teardownSubscriptions=function(){this._filter.unsubscribeGlobally(this,this._entityName)};c.prototype.addEventListener=function(x,y){var A=this;var z=this.oldAddEventListener(x,y);if(this.subscribers[x].length===1){this.setupSubscriptions()}z.oldUnsubscribe=z.unsubscribe;z.unsubscribe=function(){this.oldUnsubscribe();if(A.subscribers[x].length===0){A.teardownSubscriptions()}};return z};c.prototype.persistQueries=function(){return[]};c.prototype.init=function(z,x,y){this._filter=new g();this._orderColumns=[];this._prefetchFields=[];this._entityName=x;this._constructor=y;this._limit=-1;this._skip=0;this._reverse=false;this._session=z||b;this.subscribers={}};c.prototype.toUniqueString=function(){var A=this._constructor.name+": "+this._entityName;A+="|Filter:";var x=[];A+=this._filter.toUniqueString();A+="|Values:";for(var z=0;z<x.length;z++){A+=x+"|^|"}A+="|Order:";for(var z=0;z<this._orderColumns.length;z++){var y=this._orderColumns[z];A+=y[0]+", "+y[1]}A+="|Prefetch:";for(var z=0;z<this._prefetchFields.length;z++){A+=this._prefetchFields[z]}A+="|Limit:";A+=this._limit;A+="|Skip:";A+=this._skip;A+="|Reverse:";A+=this._reverse;return A};c.prototype.clone=function(z){var A=new (this._constructor)(this._session,this._entityName);A._filter=this._filter;A._prefetchFields=this._prefetchFields.slice(0);A._orderColumns=this._orderColumns.slice(0);A._limit=this._limit;A._skip=this._skip;A._reverse=this._reverse;if(z){var y={};for(var x in this.subscribers){if(this.subscribers.hasOwnProperty(x)){y[x]=this.subscribers[x].slice(0)}}A.subscribers=y}else{A.subscribers=this.subscribers}return A};c.prototype.filter=function(z,x,y){var B=this.clone(true);B._filter=new h(this._filter,new q(z,x,y));var A=this._session;B=A.uniqueQueryCollection(B);return A.uniqueQueryCollection(B)};c.prototype.or=function(x){var y=this.clone(true);y._filter=new n(this._filter,x);return this._session.uniqueQueryCollection(y)};c.prototype.and=function(x){var y=this.clone(true);y._filter=new h(this._filter,x);return this._session.uniqueQueryCollection(y)};c.prototype.order=function(y,x){x=x===undefined?true:x;var z=this.clone();z._orderColumns.push([y,x]);return this._session.uniqueQueryCollection(z)};c.prototype.limit=function(y){var x=this.clone();x._limit=y;return this._session.uniqueQueryCollection(x)};c.prototype.skip=function(y){var x=this.clone();x._skip=y;return this._session.uniqueQueryCollection(x)};c.prototype.reverse=function(){var x=this.clone();x._reverse=true;return this._session.uniqueQueryCollection(x)};c.prototype.prefetch=function(x){var y=this.clone();y._prefetchFields.push(x);return this._session.uniqueQueryCollection(y)};c.prototype.selectJSON=function(x,z,D){var y=a.getArgs(arguments,[{name:"tx",optional:true,check:b.isTransaction,defaultValue:null},{name:"props",optional:false},{name:"callback",optional:false}]);var B=this._session;var A=this;x=y.tx;z=y.props;D=y.callback;if(!x){B.transaction(function(E){A.selectJSON(E,z,D)});return}var C=k(this._entityName);this.list(function(E){var F=[];b.asyncForEach(E,function(G,H){G.selectJSON(x,z,function(I){F.push(I);H()})},function(){D(F)})})};c.prototype.add=function(x){if(!x.id||!x._type){throw new Error("Cannot add object of non-entity type onto collection.")}this._session.add(x);this._filter.makeFit(x);this.triggerEvent("add",this,x);this.triggerEvent("change",this,x)};c.prototype.addAll=function(z){for(var x=0;x<z.length;x++){var y=z[x];this._session.add(y);this._filter.makeFit(y);this.triggerEvent("add",this,y)}this.triggerEvent("change",this)};c.prototype.remove=function(x){if(!x.id||!x._type){throw new Error("Cannot remove object of non-entity type from collection.")}this._filter.makeNotFit(x);this.triggerEvent("remove",this,x);this.triggerEvent("change",this,x)};function p(y,x){this.init(y,x,p)}c.prototype.each=function(x,z){var y=a.getArgs(arguments,[{name:"tx",optional:true,check:b.isTransaction,defaultValue:null},{name:"eachFn",optional:true,check:a.isCallback()}]);x=y.tx;z=y.eachFn;this.list(x,function(B){for(var A=0;A<B.length;A++){z(B[A])}})};c.prototype.forEach=c.prototype.each;c.prototype.one=function(x,z){var y=a.getArgs(arguments,[{name:"tx",optional:true,check:b.isTransaction,defaultValue:null},{name:"oneFn",optional:false,check:a.isCallback()}]);x=y.tx;z=y.oneFn;var A=this;this.limit(1).list(x,function(B){if(B.length===0){z(null)}else{z(B[0])}})};p.prototype=new c();function l(y,x){this.init(y,x,l)}l.prototype=new p();l.prototype.add=function(x){this._session.add(x);this.triggerEvent("add",this,x);this.triggerEvent("change",this,x)};l.prototype.remove=function(x){this._session.remove(x);this.triggerEvent("remove",this,x);this.triggerEvent("change",this,x)};function t(y,x){this.init(y,x,b.ManyToManyDbQueryCollection);this._localAdded=[];this._localRemoved=[]}t.prototype=new p();t.prototype.initManyToMany=function(y,x){this._obj=y;this._coll=x};t.prototype.add=function(x){if(!u(this._localAdded,x)){this._session.add(x);this._localAdded.push(x);this.triggerEvent("add",this,x);this.triggerEvent("change",this,x)}};t.prototype.addAll=function(z){for(var x=0;x<z.length;x++){var y=z[x];if(!u(this._localAdded,y)){this._session.add(y);this._localAdded.push(y);this.triggerEvent("add",this,y)}}this.triggerEvent("change",this)};t.prototype.clone=function(){var x=p.prototype.clone.call(this);x._localAdded=this._localAdded;x._localRemoved=this._localRemoved;x._obj=this._obj;x._coll=this._coll;return x};t.prototype.remove=function(x){if(u(this._localAdded,x)){j(this._localAdded,x)}else{if(!u(this._localRemoved,x)){this._localRemoved.push(x)}}this.triggerEvent("remove",this,x);this.triggerEvent("change",this,x)};function w(x){this.init(b,null,w);this._items=x||[]}w.prototype=new c();w.prototype.clone=function(){var x=p.prototype.clone.call(this);x._items=this._items;return x};w.prototype.add=function(x){if(!u(this._items,x)){this._session.add(x);this._items.push(x);this.triggerEvent("add",this,x);this.triggerEvent("change",this,x)}};w.prototype.addAll=function(z){for(var x=0;x<z.length;x++){var y=z[x];if(!u(this._items,y)){this._session.add(y);this._items.push(y);this.triggerEvent("add",this,y)}}this.triggerEvent("change",this)};w.prototype.remove=function(z){var x=this._items;for(var y=0;y<x.length;y++){if(x[y]===z){this._items.splice(y,1);this.triggerEvent("remove",this,z);this.triggerEvent("change",this,z)}}};w.prototype.list=function(x,D){var y=a.getArgs(arguments,[{name:"tx",optional:true,check:b.isTransaction,defaultValue:null},{name:"callback",optional:true,check:a.isCallback()}]);D=y.callback;if(!D||D.executeSql){D=arguments[1]}var C=this._items.slice(0);var B=this;var A=[];for(var z=0;z<C.length;z++){if(this._filter.match(C[z])){A.push(C[z])}}A.sort(function(G,F){for(var I=0;I<B._orderColumns.length;I++){var H=B._orderColumns[I][0];var J=B._orderColumns[I][1];var E=b.get(G,H);var K=b.get(F,H);if(E<K){return J?-1:1}else{if(E>K){return J?1:-1}}}return 0});if(this._skip){A.splice(0,this._skip)}if(this._limit>-1){A=A.slice(0,this._limit)}if(this._reverse){A.reverse()}if(D){D(A)}else{return A}};w.prototype.destroyAll=function(x){if(!x||x.executeSql){x=arguments[1]}this._items=[];this.triggerEvent("change",this);if(x){x()}};w.prototype.count=function(y,A){var z=a.getArgs(arguments,[{name:"tx",optional:true,check:b.isTransaction,defaultValue:null},{name:"callback",optional:true,check:a.isCallback()}]);y=z.tx;A=z.callback;var x=this.list();if(A){A(x.length)}else{return x.length}};b.QueryCollection=c;b.DbQueryCollection=p;b.ManyToManyDbQueryCollection=t;b.LocalQueryCollection=w;b.Observable=m;b.Subscription=o;b.AndFilter=h;b.OrFilter=n;b.PropertyFilter=q}());var a={};(function(){a.getArgs=function(f,j){var d=0;var g=0;var i={};while(g<j.length){var h=j[g];var c=f[d];if(h.optional){if(c!==undefined&&h.check(c)){i[h.name]=c;d++;g++}else{if(h.defaultValue!==undefined){i[h.name]=h.defaultValue}g++}}else{if(h.check&&!h.check(c)){throw new Error("Invalid value for argument: "+h.name+" Value: "+c)}i[h.name]=c;g++;d++}}return i};a.hasProperty=function(c){return function(d){return d&&d[c]!==undefined}};a.hasType=function(c){return function(d){return typeof d===c}};a.isCallback=function(){return function(c){return c&&c.apply}}}());b.argspec=a;return b}if(typeof JSON==="undefined"){JSON={}}if(!JSON.stringify){(function(){function f(n){return n<10?"0"+n:n}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf()}}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){k=rep[i];if(typeof k==="string"){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}if(typeof JSON.stringify!=="function"){JSON.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":value})}}if(typeof JSON.parse!=="function"){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}}}())}if(!window.persistence){throw new Error("persistence.js should be loaded before persistence.migrations.js")}(function(){var c={migrations:[],version:function(d){persistence.transaction(function(f){f.executeSql("SELECT current_version FROM schema_version",null,function(g){if(g.length==0){f.executeSql("INSERT INTO schema_version VALUES (0)",null,function(){d(0)})}else{d(g[0].current_version)}})})},setVersion:function(d,f){persistence.transaction(function(g){g.executeSql("UPDATE schema_version SET current_version = ?",[d],function(){c._version=d;if(f){f()}})})},setup:function(d){persistence.transaction(function(f){f.executeSql("CREATE TABLE IF NOT EXISTS schema_version (current_version INTEGER)",null,function(){c.migration(0,{up:function(){},down:function(){}});if(d){d()}})})},reset:function(d){c.migrations=[];c.migration(0,{up:function(){},down:function(){}});c.setVersion(0,d)},migration:function(d,f){c.migrations[d]=new a(d,f);return c.migrations[d]},migrateUpTo:function(f,h){var d=[];function g(){var i=d.pop();if(!i){h()}i.up(function(){if(d.length>0){g()}else{if(h){h()}}})}this.version(function(i){for(var j=i+1;j<=f;j++){d.unshift(c.migrations[j])}if(d.length>0){g()}else{if(h){h()}}})},migrateDownTo:function(f,h){var d=[];function g(){var i=d.pop();if(!i){h()}i.down(function(){if(d.length>0){g()}else{if(h){h()}}})}this.version(function(i){for(var j=i;j>=f;j--){d.unshift(c.migrations[j])}if(d.length>0){g()}else{if(h){h()}}})},migrate:function(d,f){if(arguments.length===1){f=d;d=this.migrations.length-1}this.version(function(g){if(g<d){c.migrateUpTo(d,f)}else{if(g>d){c.migrateDownTo(d,f)}else{f()}}})}};var a=function(f,d){this.version=f;this.body=d;this.actions=[]};a.prototype.executeActions=function(g){var f=this.actions;var d=this.version;persistence.transaction(function(i){function h(){if(f.length==0){c.setVersion(d,g)}else{var j=f.pop();j(i,h)}}h()})};a.prototype.up=function(d){if(this.body.up){this.body.up.apply(this)}this.executeActions(d)};a.prototype.down=function(d){if(this.body.down){this.body.down.apply(this)}this.executeActions(d)};a.prototype.createTable=function(d,i){var g=new b();if(i){i(g)}var f;var h="CREATE TABLE "+d+" (id VARCHAR(32) PRIMARY KEY";while(f=g.columns.pop()){h+=", "+f}this.executeSql(h+")")};a.prototype.dropTable=function(d){var f="DROP TABLE "+d;this.executeSql(f)};a.prototype.addColumn=function(f,d,g){var h="ALTER TABLE "+f+" ADD "+d+" "+g;this.executeSql(h)};a.prototype.removeColumn=function(f,d){this.action(function(h,g){var i='select sql from sqlite_master where type = "table" and name == "'+f+'"';h.executeSql(i,null,function(j){var o=new RegExp("CREATE TABLE `\\w+` |\\w+ \\((.+)\\)").exec(j[0].sql)[1].split(", ");var m=[];var l=[];for(var n=0;n<o.length;n++){var p=new RegExp("((`\\w+`)|(\\w+)) .+").exec(o[n])[1];if(p==d){continue}l.push(o[n]);m.push(p)}l=l.join(", ");m=m.join(", ");var k=[];k.unshift(["ALTER TABLE "+f+" RENAME TO "+f+"_bkp;",null]);k.unshift(["CREATE TABLE "+f+" ("+l+");",null]);k.unshift(["INSERT INTO "+f+" SELECT "+m+" FROM "+f+"_bkp;",null]);k.unshift(["DROP TABLE "+f+"_bkp;",null]);persistence.executeQueriesSeq(h,k,g)})})};a.prototype.addIndex=function(f,d,h){var g="CREATE "+(h===true?"UNIQUE":"")+" INDEX "+f+"_"+d+" ON "+f+" ("+d+")";this.executeSql(g)};a.prototype.removeIndex=function(f,d){var g="DROP INDEX "+f+"_"+d;this.executeSql(g)};a.prototype.executeSql=function(f,d){this.action(function(h,g){h.executeSql(f,d,g)})};a.prototype.action=function(d){this.actions.unshift(d)};var b=function(){this.columns=[]};b.prototype.text=function(d){this.columns.unshift(d+" TEXT")};b.prototype.integer=function(d){this.columns.unshift(d+" INT")};b.prototype.real=function(d){this.columns.unshift(d+" REAL")};b.prototype["boolean"]=function(d){this.columns.unshift(d+" BOOL")};b.prototype.date=function(d){this.columns.unshift(d+" DATE")};b.prototype.json=function(d){this.columns.unshift(d+" TEXT")};persistence.migrations={};persistence.migrations.Migrator=c;persistence.migrations.Migration=a;persistence.migrations.init=function(){c.setup.apply(c,Array.prototype.slice.call(arguments,0))};persistence.migrate=function(){c.migrate.apply(c,Array.prototype.slice.call(arguments,0))};persistence.defineMigration=function(){c.migration.apply(c,Array.prototype.slice.call(arguments,0))}}());var defaultTypeMapper={idType:"VARCHAR(32)",classNameType:"TEXT",columnType:function(a){switch(a){case"JSON":return"TEXT";case"BOOL":return"INT";case"DATE":return"INT";default:return a}},inVar:function(b,a){return b},outVar:function(b,a){return b},outId:function(a){return"'"+a+"'"},dbValToEntityVal:function(b,a){if(b===null||b===undefined){return b}switch(a){case"DATE":if(b>1000000000000){return new Date(parseInt(b,10))}else{return new Date(parseInt(b,10)*1000)}case"BOOL":return b===1||b==="1";break;case"INT":return +b;break;case"BIGINT":return +b;break;case"JSON":if(b){return JSON.parse(b)}else{return b}break;default:return b}},entityValToDbVal:function(b,a){if(b===undefined||b===null){return null}else{if(a==="JSON"&&b){return JSON.stringify(b)}else{if(b.id){return b.id}else{if(a==="BOOL"){return(b==="false")?0:(b?1:0)}else{if(a==="DATE"||b.getTime){b=new Date(b);return Math.round(b.getTime()/1000)}else{return b}}}}}},inIdVar:function(a){return this.inVar(a,this.idType)},outIdVar:function(a){return this.outVar(a,this.idType)},entityIdToDbId:function(a){return this.entityValToDbVal(a,this.idType)}};function config(i,b){var g=i.argspec;i.typeMapper=b.typeMapper||defaultTypeMapper;i.generatedTables={};i.schemaSync=function(F,x,r){var s=g.getArgs(arguments,[{name:"tx",optional:true,check:i.isTransaction,defaultValue:null},{name:"callback",optional:true,check:g.isCallback(),defaultValue:function(){}},{name:"emulate",optional:true,check:g.hasType("boolean")}]);F=s.tx;x=s.callback;r=s.emulate;if(!F){var o=this;this.transaction(function(G){o.schemaSync(G,x,r)});return}var E=[],A,C,B,w;var v=i.typeMapper;var m=i.getEntityMeta();for(var z in m){if(m.hasOwnProperty(z)){A=m[z];if(!A.isMixin){C=[];for(var u in A.fields){if(A.fields.hasOwnProperty(u)){C.push([u,A.fields[u]])}}for(var t in A.hasOne){if(A.hasOne.hasOwnProperty(t)){B=A.hasOne[t].type.meta;C.push([t,v.idType]);E.push([b.createIndex(A.name,[t]),null])}}for(var D=0;D<A.indexes.length;D++){E.push([b.createIndex(A.name,A.indexes[D].columns,A.indexes[D]),null])}}for(var t in A.hasMany){if(A.hasMany.hasOwnProperty(t)&&A.hasMany[t].manyToMany){w=A.hasMany[t].tableName;if(!i.generatedTables[w]){var B=A.hasMany[t].type.meta;var l=A.hasMany[t].inverseProperty;if(B.hasMany[l].type.meta!=A){continue}var q=A.name+"_"+t;var n=B.name+"_"+l;E.push([b.createIndex(w,[q]),null]);E.push([b.createIndex(w,[n]),null]);var p=[[q,v.idType],[n,v.idType]];if(A.isMixin){p.push([q+"_class",v.classNameType])}if(B.isMixin){p.push([n+"_class",v.classNameType])}E.push([b.createTable(w,p),null]);i.generatedTables[w]=true}}}if(!A.isMixin){C.push(["id",v.idType,"PRIMARY KEY"]);i.generatedTables[A.name]=true;E.push([b.createTable(A.name,C),null])}}}var y=i.schemaSyncHooks;for(var D=0;D<y.length;D++){y[D](F)}if(r){x(F)}else{j(F,E,function(G,H){x(F,H)})}};i.flush=function(l,p){var m=g.getArgs(arguments,[{name:"tx",optional:true,check:i.isTransaction},{name:"callback",optional:true,check:g.isCallback(),defaultValue:null}]);l=m.tx;p=m.callback;var o=this;if(!l){this.transaction(function(q){o.flush(q,p)});return}var n=i.flushHooks;i.asyncForEach(n,function(q,r){q(o,l,r)},function(){var s=[];for(var t in o.trackedObjects){if(o.trackedObjects.hasOwnProperty(t)){s.push(o.trackedObjects[t])}}var q=[];for(var t in o.objectsToRemove){if(o.objectsToRemove.hasOwnProperty(t)){q.push(o.objectsToRemove[t]);delete o.trackedObjects[t]}}o.objectsToRemove={};if(p){i.asyncParForEach(q,function(u,v){d(u,l,v)},function(u,v){if(v){return p(u,v)}i.asyncParForEach(s,function(w,x){h(w,l,x)},p)})}else{for(var r=0;r<s.length;r++){h(s[r],l)}for(var r=0;r<q.length;r++){d(q[r],l)}}})};i.reset=function(l,o){var m=g.getArgs(arguments,[{name:"tx",optional:true,check:i.isTransaction,defaultValue:null},{name:"callback",optional:true,check:g.isCallback(),defaultValue:function(){}}]);l=m.tx;o=m.callback;var n=this;if(!l){n.transaction(function(p){n.reset(p,o)});return}this.schemaSync(l,function(){var r=[];for(var s in i.generatedTables){if(i.generatedTables.hasOwnProperty(s)){r.push(s)}}function t(){var p=r.pop();l.executeSql("DROP TABLE IF EXISTS `"+p+"`",null,function(){if(r.length>0){t()}else{q()}},q)}if(r.length>0){t()}else{q()}function q(p,u){n.clean();i.generatedTables={};if(o){o(p,u)}}},true)};function k(s,t,w,q){q=q||"";if(s.trackedObjects[w[q+"id"]]){return s.trackedObjects[w[q+"id"]]}var v=i.typeMapper;var u=i.getMeta(t);var r=i.define(t);if(!w[q+"id"]){return null}var n=new r(s,undefined,true);n.id=v.dbValToEntityVal(w[q+"id"],v.idType);n._new=false;for(var m in w){if(w.hasOwnProperty(m)){if(m.substring(0,q.length)===q){var l=m.substring(q.length);if(l!="id"){n._data[l]=v.dbValToEntityVal(w[m],u.fields[l]||v.idType)}}}}return n}function h(n,o,v){var x=i.getMeta(n._type);var w=i.typeMapper;var r=[];var u=[];var t=[];var q=[];if(n._new){for(var m in x.fields){if(x.fields.hasOwnProperty(m)){n._dirtyProperties[m]=true}}}for(var m in n._dirtyProperties){if(n._dirtyProperties.hasOwnProperty(m)){r.push("`"+m+"`");var s=x.fields[m]||w.idType;u.push(w.entityValToDbVal(n._data[m],s));t.push(w.outVar("?",s));q.push("`"+m+"` = "+w.outVar("?",s))}}var l=[];for(var m in x.hasMany){if(x.hasMany.hasOwnProperty(m)){l=l.concat(i.get(n,m).persistQueries())}}j(o,l,function(){if(r.length===0){if(v){v()}return}n._dirtyProperties={};if(n._new){r.push("id");u.push(w.entityIdToDbId(n.id));t.push(w.outIdVar("?"));var p="INSERT INTO `"+n._type+"` ("+r.join(", ")+") VALUES ("+t.join(", ")+")";n._new=false;o.executeSql(p,u,v,v)}else{var p="UPDATE `"+n._type+"` SET "+q.join(",")+" WHERE id = "+w.outId(n.id);o.executeSql(p,u,v,v)}})}i.save=h;function d(r,n,s){var q=i.getMeta(r._type);var m=i.typeMapper;var p=[["DELETE FROM `"+r._type+"` WHERE id = "+m.outId(r.id),null]];for(var l in q.hasMany){if(q.hasMany.hasOwnProperty(l)&&q.hasMany[l].manyToMany){var o=q.hasMany[l].tableName;p.push(["DELETE FROM `"+o+"` WHERE `"+q.name+"_"+l+"` = "+m.outId(r.id),null])}}j(n,p,s)}function j(l,m,p){var o=[];for(var n=3;n<arguments.length;n++){o.push(arguments[n])}i.asyncForEach(m,function(q,r){l.executeSql(q[0],q[1],r,function(s,t){console.log(t.message);r(s,t)})},function(q,r){if(r&&p){p(q,r);return}if(p){p.apply(null,o)}})}i.executeQueriesSeq=j;i.QueryCollection.prototype.persistQueries=function(){return[]};var c=i.QueryCollection.prototype.clone;i.QueryCollection.prototype.clone=function(l){var m=c.call(this,l);m._additionalJoinSqls=this._additionalJoinSqls.slice(0);m._additionalWhereSqls=this._additionalWhereSqls.slice(0);m._additionalGroupSqls=this._additionalGroupSqls.slice(0);m._manyToManyFetch=this._manyToManyFetch;return m};var a=i.QueryCollection.prototype.init;i.QueryCollection.prototype.init=function(n,l,m){a.call(this,n,l,m);this._manyToManyFetch=null;this._additionalJoinSqls=[];this._additionalWhereSqls=[];this._additionalGroupSqls=[]};var f=i.QueryCollection.prototype.toUniqueString;i.QueryCollection.prototype.toUniqueString=function(){var m=f.call(this);m+="|JoinSQLs:";for(var l=0;l<this._additionalJoinSqls.length;l++){m+=this._additionalJoinSqls[l]}m+="|WhereSQLs:";for(var l=0;l<this._additionalWhereSqls.length;l++){m+=this._additionalWhereSqls[l]}m+="|GroupSQLs:";for(var l=0;l<this._additionalGroupSqls.length;l++){m+=this._additionalGroupSqls[l]}if(this._manyToManyFetch){m+="|ManyToManyFetch:";m+=JSON.stringify(this._manyToManyFetch)}return m};i.NullFilter.prototype.sql=function(n,m,l){return"1=1"};i.AndFilter.prototype.sql=function(n,m,l){return"("+this.left.sql(n,m,l)+" AND "+this.right.sql(n,m,l)+")"};i.OrFilter.prototype.sql=function(n,m,l){return"("+this.left.sql(n,m,l)+" OR "+this.right.sql(n,m,l)+")"};i.PropertyFilter.prototype.sql=function(t,m,r){var s=i.typeMapper;var u=m?"`"+m+"`.":"";var q=t.fields[this.property]||s.idType;if(this.operator==="="&&this.value===null){return u+"`"+this.property+"` IS NULL"}else{if(this.operator==="!="&&this.value===null){return u+"`"+this.property+"` IS NOT NULL"}else{if(this.operator==="in"){var o=this.value;var n=[];for(var l=0;l<o.length;l++){n.push("?");r.push(s.entityValToDbVal(o[l],q))}if(o.length===0){return"1 = 0"}else{return u+"`"+this.property+"` IN ("+n.join(", ")+")"}}else{if(this.operator==="not in"){var o=this.value;var n=[];for(var l=0;l<o.length;l++){n.push("?");r.push(s.entityValToDbVal(o[l],q))}if(o.length===0){return"1 = 1"}else{return u+"`"+this.property+"` NOT IN ("+n.join(", ")+")"}}else{var p=this.value;if(p===true||p===false){p=p?1:0}r.push(s.entityValToDbVal(p,q));return u+"`"+this.property+"` "+this.operator+" "+s.outVar("?",q)}}}}};i.DbQueryCollection.prototype.list=function(F,q){var o=g.getArgs(arguments,[{name:"tx",optional:true,check:i.isTransaction,defaultValue:null},{name:"callback",optional:false,check:g.isCallback()}]);F=o.tx;q=o.callback;var t=this;var n=this._session;if(!F){n.transaction(function(H){t.list(H,q)});return}var x=this._entityName;var y=i.getMeta(x);var p=i.typeMapper;if(y.isMixin){var v=[];i.asyncForEach(y.mixedIns,function(J,H){var I=t.clone();I._entityName=J.name;I.list(F,function(K){v=v.concat(K);H()})},function(){var H=new i.LocalQueryCollection(v);H._orderColumns=t._orderColumns;H._reverse=t._reverse;H.list(null,q)});return}function E(K,L,I){var H=[p.inIdVar("`"+L+"`.id")+" AS "+I+"id"];for(var J in K.fields){if(K.fields.hasOwnProperty(J)){H.push(p.inVar("`"+L+"`.`"+J+"`",K.fields[J])+" AS `"+I+J+"`")}}for(var J in K.hasOne){if(K.hasOne.hasOwnProperty(J)){H.push(p.inIdVar("`"+L+"`.`"+J+"`")+" AS `"+I+J+"`")}}return H}var o=[];var A=x+"_";var u="root";var G=E(y,u,A);var l="";var m=this._additionalWhereSqls.slice(0);var w=this._manyToManyFetch;if(w){l+="LEFT JOIN `"+w.table+"` AS mtm ON mtm.`"+w.inverseProp+"` = `root`.`id` ";m.push("mtm.`"+w.prop+"` = "+p.outId(w.id))}l+=this._additionalJoinSqls.join(" ");for(var C=0;C<this._prefetchFields.length;C++){var r=this._prefetchFields[C];var s=y.hasOne[r].type.meta;if(s.isMixin){throw new Error("cannot prefetch a mixin")}var B=s.name+"_"+r+"_tbl";G=G.concat(E(s,B,r+"_"));l+="LEFT JOIN `"+s.name+"` AS `"+B+"` ON `"+B+"`.`id` = `"+u+"`.`"+r+"` "}var z="WHERE "+[this._filter.sql(y,u,o)].concat(m).join(" AND ");var D="SELECT "+G.join(", ")+" FROM `"+x+"` AS `"+u+"` "+l+" "+z;if(this._additionalGroupSqls.length>0){D+=this._additionalGroupSqls.join(" ")}if(this._orderColumns.length>0){D+=" ORDER BY "+this._orderColumns.map(function(H){return"`"+A+H[0]+"` "+(H[1]?"ASC":"DESC")}).join(", ")}if(this._limit>=0){D+=" LIMIT "+this._limit}if(this._skip>0){D+=" OFFSET "+this._skip}n.flush(F,function(){F.executeSql(D,o,function(N){var J=[];if(t._reverse){N.reverse()}for(var I=0;I<N.length;I++){var M=N[I];var O=k(n,x,M,A);for(var H=0;H<t._prefetchFields.length;H++){var L=t._prefetchFields[H];var K=y.hasOne[L].type.meta;O._data_obj[L]=k(n,K.name,M,L+"_");n.add(O._data_obj[L])}J.push(O);n.add(O)}q(J);t.triggerEvent("list",t,J)})})};i.DbQueryCollection.prototype.destroyAll=function(o,x){var r=g.getArgs(arguments,[{name:"tx",optional:true,check:i.isTransaction,defaultValue:null},{name:"callback",optional:true,check:g.isCallback(),defaultValue:function(){}}]);o=r.tx;x=r.callback;var p=this;var t=this._session;if(!o){t.transaction(function(A){p.destroyAll(A,x)});return}var v=this._entityName;var z=i.getMeta(v);var y=i.typeMapper;if(z.isMixin){i.asyncForEach(z.mixedIns,function(C,A){var B=p.clone();B._entityName=C.name;B.destroyAll(o,x)},x);return}var w="";var u=this._additionalWhereSqls.slice(0);var q=this._manyToManyFetch;if(q){w+="LEFT JOIN `"+q.table+"` AS mtm ON mtm.`"+q.inverseProp+"` = `root`.`id` ";u.push("mtm.`"+q.prop+"` = "+y.outId(q.id))}w+=this._additionalJoinSqls.join(" ");var r=[];var s="WHERE "+[this._filter.sql(z,null,r)].concat(u).join(" AND ");var n="SELECT id FROM `"+v+"` "+w+" "+s;var m="DELETE FROM `"+v+"` "+w+" "+s;var l=r.slice(0);t.flush(o,function(){o.executeSql(n,r,function(B){for(var A=0;A<B.length;A++){delete t.trackedObjects[B[A].id];t.objectsRemoved.push({id:B[A].id,entity:v})}p.triggerEvent("change",p);o.executeSql(m,l,x,x)},x)})};i.DbQueryCollection.prototype.count=function(l,u){var o=g.getArgs(arguments,[{name:"tx",optional:true,check:i.isTransaction,defaultValue:null},{name:"callback",optional:false,check:g.isCallback()}]);l=o.tx;u=o.callback;var m=this;var q=this._session;if(l&&!l.executeSql){u=l;l=null}if(!l){q.transaction(function(z){m.count(z,u)});return}var s=this._entityName;var w=i.getMeta(s);var v=i.typeMapper;if(w.isMixin){var y=0;i.asyncForEach(w.mixedIns,function(B,z){var A=m.clone();A._entityName=B.name;A.count(l,function(C){y+=C;z()})},function(){u(y)});return}var t="";var r=this._additionalWhereSqls.slice(0);var n=this._manyToManyFetch;if(n){t+="LEFT JOIN `"+n.table+"` AS mtm ON mtm.`"+n.inverseProp+"` = `root`.`id` ";r.push("mtm.`"+n.prop+"` = "+v.outId(n.id))}t+=this._additionalJoinSqls.join(" ");var o=[];var p="WHERE "+[this._filter.sql(w,"root",o)].concat(r).join(" AND ");var x="SELECT COUNT(*) AS cnt FROM `"+s+"` AS `root` "+t+" "+p;q.flush(l,function(){l.executeSql(x,o,function(z){u(parseInt(z[0].cnt,10))})})};i.ManyToManyDbQueryCollection.prototype.persistQueries=function(){var q=[];var v=i.getMeta(this._obj._type);var n=v.hasMany[this._coll].type.meta;var u=i.typeMapper;var w=v.hasMany[this._coll];var r=n.hasMany[w.inverseProperty];var m=w.mixin?w.mixin.meta.name:v.name;var o=r.mixin?r.mixin.meta.name:n.name;for(var p=0;p<this._localAdded.length;p++){var l=[m+"_"+this._coll,o+"_"+w.inverseProperty];var t=[u.outIdVar("?"),u.outIdVar("?")];var s=[u.entityIdToDbId(this._obj.id),u.entityIdToDbId(this._localAdded[p].id)];if(w.mixin){l.push(m+"_"+this._coll+"_class");t.push("?");s.push(v.name)}if(r.mixin){l.push(o+"_"+w.inverseProperty+"_class");t.push("?");s.push(n.name)}q.push(["INSERT INTO "+w.tableName+" (`"+l.join("`, `")+"`) VALUES ("+t.join(",")+")",s])}this._localAdded=[];for(var p=0;p<this._localRemoved.length;p++){q.push(["DELETE FROM  "+w.tableName+" WHERE `"+m+"_"+this._coll+"` = "+u.outIdVar("?")+" AND `"+o+"_"+w.inverseProperty+"` = "+u.outIdVar("?"),[u.entityIdToDbId(this._obj.id),u.entityIdToDbId(this._localRemoved[p].id)]])}this._localRemoved=[];return q}}if(typeof exports!=="undefined"){exports.defaultTypeMapper=defaultTypeMapper;exports.config=config}else{window=window||{};window.persistence=window.persistence||{};window.persistence.store=window.persistence.store||{};window.persistence.store.sql={defaultTypeMapper:defaultTypeMapper,config:config}}try{if(!window){window={}}}catch(e){window={};exports.console=console}var persistence=(window&&window.persistence)?window.persistence:{};if(!persistence.store){persistence.store={}}persistence.store.websql={};persistence.store.websql.config=function(d,g,c,a){var b=null;d.transaction=function(h){if(!b){throw new Error("No ongoing database connection, please connect first.")}else{b.transaction(h)}};d.db=d.db||{};d.db.implementation="unsupported";d.db.conn=null;if(window&&window.openDatabase){d.db.implementation="html5"}else{if(window&&window.google&&google.gears){d.db.implementation="gears"}else{try{if(openDatabaseSync){d.db.implementation="html5-sync"}}catch(f){}}}d.db.html5={};d.db.html5.connect=function(l,k,h){var j={};var i=openDatabase(l,"1.0",k,h);j.transaction=function(m){return i.transaction(function(n){return m(d.db.html5.transaction(n))})};return j};d.db.html5.transaction=function(h){var i={};i.executeSql=function(l,k,j,m){if(d.debug){console.log(l,k)}h.executeSql(l,k,function(o,n){if(j){var q=[];for(var p=0;p<n.rows.length;p++){q.push(n.rows.item(p))}j(q)}},m)};return i};d.db.html5Sync={};d.db.html5Sync.connect=function(l,k,h){var j={};var i=openDatabaseSync(l,"1.0",k,h);j.transaction=function(m){return i.transaction(function(n){return m(d.db.html5Sync.transaction(n))})};return j};d.db.html5Sync.transaction=function(h){var i={};i.executeSql=function(o,l,k,p){if(l==null){l=[]}if(d.debug){console.log(o,l)}var j=h.executeSql(o,l);if(j){if(k){var n=[];for(var m=0;m<j.rows.length;m++){n.push(j.rows.item(m))}k(n)}}};return i};d.db.gears={};d.db.gears.connect=function(j){var i={};var h=google.gears.factory.create("beta.database");h.open(j);i.transaction=function(k){k(d.db.gears.transaction(h))};return i};d.db.gears.transaction=function(i){var h={};h.executeSql=function(p,m,k,q){if(d.debug){console.log(p,m)}var l=i.execute(p,m);if(k){var o=[];while(l.isValidRow()){var j={};for(var n=0;n<l.fieldCount();n++){j[l.fieldName(n)]=l.field(n)}o.push(j);l.next()}k(o)}};return h};d.db.connect=function(j,i,h){if(d.db.implementation=="html5"){return d.db.html5.connect(j,i,h)}else{if(d.db.implementation=="html5-sync"){return d.db.html5Sync.connect(j,i,h)}else{if(d.db.implementation=="gears"){return d.db.gears.connect(j)}}}};d.store.websql.sqliteDialect={createTable:function(k,m){var j=d.typeMapper;var o="CREATE TABLE IF NOT EXISTS `"+k+"` (";var h=[];for(var l=0;l<m.length;l++){var n=m[l];h.push("`"+n[0]+"` "+j.columnType(n[1])+(n[2]?" "+n[2]:""))}o+=h.join(", ");o+=")";return o},createIndex:function(h,j,i){i=i||{};return"CREATE "+(i.unique?"UNIQUE ":"")+"INDEX IF NOT EXISTS `"+h+"__"+j.join("_")+"` ON `"+h+"` ("+j.map(function(k){return"`"+k+"`"}).join(", ")+")"}};d.store.sql.config(d,d.store.websql.sqliteDialect);b=d.db.connect(g,c,a);if(!b){throw new Error("No supported database found in this browser.")}};try{exports.persistence=persistence}catch(e){}try{if(!window){window={}}}catch(e){window={};exports.console=console}var persistence=(window&&window.persistence)?window.persistence:{};persistence.search={};persistence.search.config=function(g,a){var h={and:true,the:true,are:true};var c=g.argspec;function d(l,m){if(!(l in h||(m&&l.length<3))){l=l.replace(/ies$/,"y");l=l.length>3?l.replace(/s$/,""):l;return l}else{return false}}function f(q){var p=q.toLowerCase().split(/[^\w\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+/);var n={};for(var m=0;m<p.length;m++){var l=d(p[m]);if(l){var o="_"+l;if(o in n){n[o]++}else{n[o]=1}}}return n}function i(q,t,n){q=q.toLowerCase().replace(/['"]/,"").replace(/(^\s+|\s+$)/g,"");var p=q.split(/\s+/);var r=[];var m=null;for(var o=0;o<p.length;o++){var l=d(p[o]);if(!l){continue}if(l.search(/:$/)!==-1){m=l.substring(0,l.length-1);continue}var s="(";if(l.search(/\*/)!==-1){s+="`"+t+"`.`word` LIKE '"+l.replace(/\*/g,"%")+"'"}else{if(n){s+="`"+t+"`.`word` LIKE '"+l+"%'"}else{s+="`"+t+"`.`word` = '"+l+"'"}}if(m){s+=" AND `"+t+"`.`prop` = '"+m+"'"}s+=")";r.push(s)}return r.length===0?["1=1"]:r}var j={};g.searchQueryCollSubscribers=j;function k(m,l){this.query=m;this.entityName=l}k.prototype.match=function(r){var n=g.getMeta(this.entityName);var l=this.query.toLowerCase();var q="";for(var m in r){if(n.textIndex.hasOwnProperty(m)){if(r[m]){q+=r[m]}}}q=q.toLowerCase();return q&&q.indexOf(l)!==-1};k.prototype.sql=function(l){return"1=1"};k.prototype.subscribeGlobally=function(m,l){var o=g.getMeta(l);for(var n in o.textIndex){if(o.textIndex.hasOwnProperty(n)){g.subscribeToGlobalPropertyListener(m,l,n)}}};k.prototype.unsubscribeGlobally=function(m,l){var o=g.getMeta(l);for(var n in o.textIndex){if(o.textIndex.hasOwnProperty(n)){g.unsubscribeFromGlobalPropertyListener(m,l,n)}}};k.prototype.toUniqueString=function(){return"SEARCH: "+this.query};function b(o,m,n,l){this.init(o,m,b);this.subscribers=j[m];this._filter=new k(n,m);if(n){this._additionalJoinSqls.push(", `"+m+"_Index`");this._additionalWhereSqls.push("`root`.id = `"+m+"_Index`.`entityId`");this._additionalWhereSqls.push("("+i(n,m+"_Index",l).join(" OR ")+")");this._additionalGroupSqls.push(" GROUP BY (`"+m+"_Index`.`entityId`)");this._additionalGroupSqls.push(" ORDER BY SUM(`"+m+"_Index`.`occurrences`) DESC")}}b.prototype=new g.DbQueryCollection();b.prototype.oldClone=b.prototype.clone;b.prototype.clone=function(){var m=this.oldClone(false);var l=this._entityName;m.subscribers=j[l];return m};b.prototype.order=function(){throw new Error("Imposing additional orderings is not support for search query collections.")};g.entityDecoratorHooks.push(function(l){l.textIndex=function(n){if(!l.meta.textIndex){l.meta.textIndex={}}l.meta.textIndex[n]=true;var m=l.meta.name;if(!j[m]){j[m]={}}};l.search=function(p,o,m){var n=c.getArgs(arguments,[{name:"session",optional:true,check:function(q){return q.schemaSync},defaultValue:g},{name:"query",optional:false,check:c.hasType("string")},{name:"prefixByDefault",optional:false}]);p=n.session;o=n.query;m=n.prefixByDefault;return p.uniqueQueryCollection(new b(p,l.meta.name,o,m))}});g.schemaSyncHooks.push(function(l){var p=g.getEntityMeta();var m=[];for(var n in p){var o=p[n];if(o.textIndex){m.push([a.createTable(n+"_Index",[["entityId","VARCHAR(32)"],["prop","VARCHAR(30)"],["word","VARCHAR(100)"],["occurrences","INT"]]),null]);m.push([a.createIndex(n+"_Index",["prop","word"]),null]);m.push([a.createIndex(n+"_Index",["word"]),null]);g.generatedTables[n+"_Index"]=true}}m.reverse();g.executeQueriesSeq(l,m)});g.flushHooks.push(function(t,s,u){var r=[];for(var n in t.getTrackedObjects()){if(t.getTrackedObjects().hasOwnProperty(n)){var q=t.getTrackedObjects()[n];var v=t.define(q._type).meta;var w=q._type+"_Index";if(v.textIndex){for(var m in q._dirtyProperties){if(q._dirtyProperties.hasOwnProperty(m)&&m in v.textIndex){r.push(["DELETE FROM `"+w+"` WHERE `entityId` = ? AND `prop` = ?",[n,m]]);var o=f(q._data[m]);for(var l in o){if(o.hasOwnProperty(l)){r.push(["INSERT INTO `"+w+"` VALUES (?, ?, ?, ?)",[q.id,m,l.substring(1),o[l]]])}}}}}}}for(var n in g.getObjectsToRemove()){if(g.getObjectsToRemove().hasOwnProperty(n)){var q=g.getObjectsToRemove()[n];var v=g.getEntityMeta()[q._type];if(v.textIndex){r.push(["DELETE FROM `"+q._type+"_Index` WHERE `entityId` = ?",[n]])}}}r.reverse();g.executeQueriesSeq(s,r,u)})};if(typeof exports==="object"){exports.config=persistence.search.config};